<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gas Monitoring Dashboard</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg1:#050b1c; --bg2:#0f1c3f;
      --card: rgba(255,255,255,0.06);
      --card-border: rgba(255,255,255,0.10);
      --shadow: 0 0 24px rgba(0,255,255,0.10);
      --text: #ffffff; --muted: rgba(255,255,255,0.70);
      --safe:#00c853; --warning:#ff9800; --danger:#f44336;
      --on:#00e676; --off:#f44336;
    }

    * { box-sizing: border-box; }
    body{
      margin:0;
      font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 60% 20%, rgba(0,255,255,0.08), transparent 55%),
                  linear-gradient(135deg, var(--bg1), var(--bg2));
      color: var(--text);
      min-height: 100vh;
    }

    .header{
      text-align:center;
      padding: 22px 16px 10px;
      font-size: 24px;
      font-weight: 900;
      letter-spacing: 0.6px;
    }

    /* ====== LAYOUT: no empty space, cards stretch to match height ====== */
    .container{
      display:grid;
      grid-template-columns: 2fr 1fr;
      grid-template-areas:
        "chart  devices"
        "manual manual";
      gap: 18px;
      padding: 18px;
      max-width: 1200px;
      margin: 0 auto;
      align-items: stretch; /* stretch items to same row height */
    }

    .card{
      background: var(--card);
      border: 1px solid var(--card-border);
      border-radius: 18px;
      padding: 18px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    .card h2{
      margin: 0 0 12px 0;
      font-size: 16px;
      font-weight: 900;
      color: rgba(255,255,255,0.94);
      display:flex;
      align-items:center;
      gap: 10px;
    }

    /* ====== CHART CARD ====== */
    .chart-card{
      grid-area: chart;
      display:flex;
      flex-direction:column;
      min-height: 540px;   /* stable height so devices column can fill */
    }

    .ppm-head{
      display:flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
    }

    .ppm-value{
      font-size: 30px;
      font-weight: 950;
      letter-spacing: 0.5px;
      display:flex;
      align-items: baseline;
      gap: 10px;
    }

    .ppm-value .unit{
      font-size: 12px;
      font-weight: 900;
      color: rgba(255,255,255,0.75);
      letter-spacing: 1px;
    }

    .ppm-sub{
      font-size: 12px;
      color: rgba(255,255,255,0.70);
      text-align: right;
      min-width: 170px;
    }

    .chart-wrap{
      position: relative;
      flex: 1 1 auto;
      min-height: 320px;
    }

    .chart-wrap canvas{
      width: 100% !important;
      height: 100% !important;
    }

    .status{
      margin-top: 12px;
      font-size: 20px;
      font-weight: 950;
      text-align:center;
      padding: 14px;
      border-radius: 14px;
      letter-spacing: 1px;
      user-select: none;
    }
    .status.safe{ background: var(--safe); }
    .status.warning{ background: var(--warning); }
    .status.danger{ background: var(--danger); }

    .meta{
      margin-top: 8px;
      font-size: 12px;
      color: var(--muted);
      text-align: right;
      user-select: none;
    }

    /* ====== DEVICES COLUMN: big icons, use full area ====== */
    .devices-col{
      grid-area: devices;
      display:grid;
      grid-template-rows: 1fr 1fr;
      gap: 18px;
      height: 100%;
      align-self: stretch;
    }

    .device-box{
      padding: 16px 16px 18px;
      display:grid;
      grid-template-rows: auto 1fr auto;
      gap: 10px;
      height: 100%;
    }

    .device-box h2{
      margin: 0;
      justify-content: flex-start;
    }

    .device-visual{
      display:flex;
      align-items:center;
      justify-content:center;
      width: 100%;
      height: 100%;
      min-height: 140px;
    }

    .device-icon{
      font-size: clamp(82px, 7.5vw, 132px);
      color: rgba(255,255,255,0.72);
      line-height: 1;
    }

    .device-status{
      width: 100%;
      min-width: 0;
      padding: 14px 14px;
      border-radius: 14px;
      font-size: 18px;
      font-weight: 950;
      letter-spacing: 1px;
      text-align:center;
    }
    .device-status.on{ background: var(--on); color: #06210f; }
    .device-status.off{ background: var(--off); color: #fff; }

    .spin{ animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .blink{ animation: blink 0.7s infinite; }
    @keyframes blink { 50% { opacity: 0.3; } }

    /* ====== MANUAL CONTROL ====== */
    .manual-card{ grid-area: manual; }

    .manual-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .control-row{
      display:flex;
      justify-content: space-between;
      align-items:center;
      padding: 12px;
      border-radius: 14px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
    }

    .control-left{
      display:flex;
      align-items:center;
      gap: 10px;
      font-weight: 900;
    }

    .chip{
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 950;
      letter-spacing: 0.5px;
      min-width: 56px;
      text-align:center;
      border: 1px solid rgba(255,255,255,0.12);
      user-select: none;
    }
    .chip.on{ background: rgba(0,230,118,0.18); border-color: rgba(0,230,118,0.35); }
    .chip.off{ background: rgba(244,67,54,0.18); border-color: rgba(244,67,54,0.35); }

    .btn{
      min-width: 120px;
      padding: 10px 12px;
      border: none;
      border-radius: 12px;
      font-weight: 950;
      letter-spacing: 0.4px;
      cursor: pointer;
      transition: transform .12s ease, opacity .12s ease;
    }
    .btn:active{ transform: scale(0.98); }
    .btn.on{ background: var(--on); color: #081a12; }
    .btn.off{ background: var(--off); color:#fff; }
    .btn[disabled]{ opacity:0.6; cursor:not-allowed; }

    .msg{
      margin-top: 10px;
      font-size: 12px;
      color: rgba(255,255,255,0.85);
      min-height: 16px;
    }

    footer{
      text-align:center;
      font-size: 12px;
      color: var(--muted);
      padding: 16px 0 18px;
    }

    /* ====== RESPONSIVE ====== */
    @media (max-width: 980px){
      .container{
        grid-template-columns: 1fr;
        grid-template-areas:
          "chart"
          "devices"
          "manual";
      }
      .chart-card{ min-height: unset; }
      .chart-wrap{ min-height: 280px; }
      .devices-col{ grid-template-rows: auto auto; height: auto; }
      .manual-grid{ grid-template-columns: 1fr; }
      .device-icon{ font-size: clamp(78px, 20vw, 128px); }
    }
  </style>
</head>

<body>
  <div class="header">GAS MONITORING SYSTEM</div>

  <div class="container">

    <!-- CHART -->
    <div class="card chart-card">
      <h2><i class="fa-solid fa-chart-line"></i> Gas Concentration</h2>

      <div class="ppm-head">
        <div class="ppm-value">
          <span id="ppmNumber">--</span>
          <span class="unit">PPM</span>
        </div>
        <div id="lastUpdated" class="ppm-sub">Last updated: --:--:--</div>
      </div>

      <div class="chart-wrap">
        <canvas id="gasChart"></canvas>
      </div>

      <div id="gasStatus" class="status safe">SAFE</div>
      <div class="meta">Warning ≥ <span id="warnTh">300</span> · Danger ≥ <span id="dangerTh">450</span></div>
    </div>

    <!-- DEVICES -->
    <div class="devices-col">

      <div class="card device-box">
        <h2><i class="fa-solid fa-wind"></i> Ventilation Fan</h2>
        <div class="device-visual">
          <i id="fanIcon" class="fa-solid fa-fan device-icon"></i>
        </div>
        <div id="fanStatus" class="device-status off">OFF</div>
      </div>

      <div class="card device-box">
        <h2><i class="fa-solid fa-bell"></i> Alarm Buzzer</h2>
        <div class="device-visual">
          <i id="buzzerIcon" class="fa-solid fa-bell device-icon"></i>
        </div>
        <div id="buzzerStatus" class="device-status off">OFF</div>
      </div>

    </div>

    <!-- MANUAL CONTROL -->
    <div class="card manual-card">
      <h2><i class="fa-solid fa-sliders"></i> Manual Control</h2>

      <div class="manual-grid">
        <div class="control-row">
          <div class="control-left">
            <i class="fa-solid fa-fan"></i>
            <span>Fan</span>
            <span id="fanChip" class="chip off">OFF</span>
          </div>
          <button id="fanBtn" class="btn on" type="button">Turn ON</button>
        </div>

        <div class="control-row">
          <div class="control-left">
            <i class="fa-solid fa-bell"></i>
            <span>Buzzer</span>
            <span id="buzzerChip" class="chip off">OFF</span>
          </div>
          <button id="buzzerBtn" class="btn on" type="button">Turn ON</button>
        </div>
      </div>

      <div id="msg" class="msg"></div>
    </div>

  </div>

  <footer>Flask + Supabase + STM32 + HC-05</footer>

<script>
  const THRESHOLD_WARNING = 300;
  const THRESHOLD_DANGER  = 450;
  const MAX_POINTS = 30;
  const CONTROL_ENDPOINT = "/api/control";

  document.getElementById("warnTh").textContent = THRESHOLD_WARNING;
  document.getElementById("dangerTh").textContent = THRESHOLD_DANGER;

  let alarmActive = false;
  let controlBusy = false;
  const deviceState = { fan:"OFF", buzzer:"OFF" };

  const gasData = [], timeData = [];

  const gasChart = new Chart(document.getElementById("gasChart"), {
    type:"line",
    data:{
      labels: timeData,
      datasets:[{
        label:"Gas PPM",
        data: gasData,
        borderWidth: 2,
        tension: .3,
        fill: true
      }]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      animation:false,
      plugins:{ legend:{ display:false } },
      scales:{ y:{} }
    }
  });

  function setMsg(t){ document.getElementById("msg").textContent = t || ""; }

  function setStatusUI(ppm){
    const box = document.getElementById("gasStatus");
    if(ppm >= THRESHOLD_DANGER){ box.className="status danger"; box.textContent="DANGER"; }
    else if(ppm >= THRESHOLD_WARNING){ box.className="status warning"; box.textContent="WARNING"; }
    else{ box.className="status safe"; box.textContent="SAFE"; }
  }

  function setDeviceUI(){
    const fanBox  = document.getElementById("fanStatus");
    const fanIcon = document.getElementById("fanIcon");
    const buzBox  = document.getElementById("buzzerStatus");
    const buzIcon = document.getElementById("buzzerIcon");

    const fanOn = alarmActive || deviceState.fan === "ON";
    const buzOn = alarmActive || deviceState.buzzer === "ON";

    fanBox.className = "device-status " + (fanOn ? "on" : "off");
    fanBox.textContent = fanOn ? "ON" : "OFF";
    fanIcon.classList.toggle("spin", fanOn);

    buzBox.className = "device-status " + (buzOn ? "on" : "off");
    buzBox.textContent = buzOn ? "ON" : "OFF";
    buzIcon.classList.toggle("blink", buzOn);
  }

  function setControlUI(){
    const fanBtn = document.getElementById("fanBtn");
    const buzBtn = document.getElementById("buzzerBtn");
    const fanChip = document.getElementById("fanChip");
    const buzChip = document.getElementById("buzzerChip");

    if(alarmActive){
      fanChip.textContent = "ON"; fanChip.className = "chip on";
      buzChip.textContent = "ON"; buzChip.className = "chip on";

      fanBtn.textContent = "LOCKED"; fanBtn.className = "btn off"; fanBtn.disabled = true;
      buzBtn.textContent = "LOCKED"; buzBtn.className = "btn off"; buzBtn.disabled = true;

      setMsg("ALARM override active (gas ≥ danger threshold). Manual control is locked.");
      return;
    }

    fanBtn.disabled = buzBtn.disabled = controlBusy;

    fanChip.textContent = deviceState.fan;
    fanChip.className = "chip " + (deviceState.fan === "ON" ? "on" : "off");
    fanBtn.textContent = (deviceState.fan === "ON") ? "Turn OFF" : "Turn ON";
    fanBtn.className = "btn " + (deviceState.fan === "ON" ? "off" : "on");

    buzChip.textContent = deviceState.buzzer;
    buzChip.className = "chip " + (deviceState.buzzer === "ON" ? "on" : "off");
    buzBtn.textContent = (deviceState.buzzer === "ON") ? "Turn OFF" : "Turn ON";
    buzBtn.className = "btn " + (deviceState.buzzer === "ON" ? "off" : "on");

    setMsg("");
  }

  async function sendControl(device){
    if(alarmActive || controlBusy) return;

    controlBusy = true;
    setControlUI();

    const next = deviceState[device] === "ON" ? "OFF" : "ON";
    setMsg(`Saving state: ${device.toUpperCase()} -> ${next} ...`);

    try{
      const res = await fetch(CONTROL_ENDPOINT,{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ device, state: next })
      });
      const out = await res.json().catch(()=> ({}));
      if(!res.ok) throw new Error(out.error || `HTTP ${res.status}`);

      deviceState[device] = next;
      setMsg("Saved OK. Python watcher will send to HC-05.");
    }catch(e){
      setMsg(`Error: ${String(e.message || e)}`);
    }finally{
      controlBusy = false;
      setControlUI();
    }
  }

  document.getElementById("fanBtn").onclick = () => sendControl("fan");
  document.getElementById("buzzerBtn").onclick = () => sendControl("buzzer");

  async function fetchData(){
    const res = await fetch("/api/latest",{ cache:"no-store" });
    const d = await res.json();

    const gas = Number(d.gas_value || 0);

    alarmActive = gas >= THRESHOLD_DANGER;

    if(!alarmActive && !controlBusy){
      deviceState.fan = d.fan || "OFF";
      deviceState.buzzer = d.buzzer || "OFF";
    }

    document.getElementById("ppmNumber").textContent = Number.isFinite(gas) ? String(gas) : "--";

    const nowStr = new Date().toLocaleTimeString();
    document.getElementById("lastUpdated").textContent = `Last updated: ${nowStr}`;

    gasData.push(gas);
    timeData.push(nowStr);
    if(gasData.length > MAX_POINTS){ gasData.shift(); timeData.shift(); }

    setStatusUI(gas);
    setDeviceUI();
    setControlUI();

    gasChart.update();
  }

  setControlUI();
  fetchData();
  setInterval(fetchData, 1000);
</script>
</body>
</html>
